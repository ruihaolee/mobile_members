var commonFuns={temInputJson:{},flag:0,get_inputValue:function(e,t){t&&(this.get_inputValue.callback=t),this.flag++;for(var n=this.flag,a=e.children(),i=0;i<a.length;i++){if(a[i]instanceof HTMLInputElement||a[i]instanceof HTMLSelectElement){var o=a[i].getAttribute("name");this.temInputJson[o]=a[i].value}this.get_inputValue($(a[i]))}1===n&&(this.flag=0,this.get_inputValue.callback(this.temInputJson))}},cutImg={coordXY:{},nowJcrop:null,startCut:function(){function e(e){if(cutImg.coordXY.x=e.x,cutImg.coordXY.y=e.y,cutImg.coordXY.width=e.w,cutImg.coordXY.height=e.h,$("#previewImg").attr("src",handle.loadImg),parseInt(e.w)>0){var t=$("#preview_box").width()/e.w,n=$("#preview_box").height()/e.h;$("#previewImg").css({width:Math.round(t*$("#shadow-before").width())+"px",height:Math.round(t*$("#shadow-before").height())+"px",marginLeft:"-"+Math.round(t*e.x)+"px",marginTop:"-"+Math.round(n*e.y)+"px"})}}$("#shadow-before").Jcrop({aspectRatio:1,onChange:e,onSelect:e,bgFade:!0,minSize:[100,100]},function(){cutImg.nowJcrop=this})}},handle={file:null,checkJson:function(e){for(var t in e)if(!e[t])return{succuss:!1,reason:"请检查是否遗漏没填的选项"};return/^1[34578]\d{9}$/.test(e.tel)?{succuss:!0}:{succuss:!1,reason:"手机号码有误,请检查"}},submitClickHandle:function(e){commonFuns.get_inputValue($("#infor"),function(e){e.sign=$("#say-area").val();var t=this.checkJson(e);return t.succuss?handle.file?handle.file.size>=2097152?void alert("请选择小于2MB的照片"):(e.gender=parseInt(e.gender),e.year=parseInt(e.year),void this.ajaxUplod(e)):void alert("请选择照片作为头像~"):void alert(t.reason)}.bind(this))},ajaxUplod:function(e){$.ajax({url:"http://member.xiyoumobile.com/api/member/submit",data:e,type:"POST",dataType:"json",success:function(e){var t={};for(var n in cutImg.coordXY)t[n]=cutImg.coordXY[n];t.image=handle.file,t.username=e.data;var a=new FormData;t.x||(t.x=0,t.y=0,t.width=.4*$(window).width(),t.height=.4*$(window).width());for(var n in t)a.append(n,t[n]);console.log(t),$("#submit-button").text("正在提交...."),$.ajax({url:"http://member.xiyoumobile.com/api/upload/avatar/2",type:"POST",cache:!1,async:!1,data:a,processData:!1,contentType:!1}).done(function(e){$("#submit-button").text("提交"),alert("上传成功！")}).fail(function(e){$("#submit-button").text("提交"),alert("上传失败！")})}})},fileChangeHandle:function(){function e(){$("#file").val(""),$("#imgBefore").attr("src",handle.loadImg),$("#shadow-before").attr("src",handle.loadImg),$("#shadow-before").css("width",n+"px"),$(".shadow").css("display","block");var e=new Image;e.src=handle.loadImg,e.onload=function(){this.coordXY.rate=Math.round($("#shadow-before").width()/e.width*100)/100,$(".shadow-beforeBox").css({marginTop:-.5*$(".shadow-beforeBox").height()+"px"}),cutImg.startCut()}.bind(cutImg)}var t=window.URL||window.webkitURL;this.loadImg=t.createObjectURL($("#file")[0].files[0]),handle.file=$("#file")[0].files[0];var n=.4*$(window).width();if("image/png"!=handle.file.type&&"image/jpeg"!=handle.file.type)return alert("请选择png/jpg格式的文件"),void(handle.file=null);var a=new Image;a.src=this.loadImg,a.onload=function(){var t=.4*$(window).width()/$(window).height(),n=a.width/a.height;if(n<=t){var i=Math.floor(100*t)/100;return void alert("请选择 宽/高 大于 "+100*i+"% 的图片")}e()}},cutOKclickHandle:function(){$(".shadow").css("display","none"),$("#previewImg").attr("src","");var e=$(".img-before").width()/cutImg.coordXY.width,t=$(".img-before").height()/cutImg.coordXY.height;$("#imgBefore").css({width:Math.round(e*$("#shadow-before").width())+"px",height:Math.round(e*$("#shadow-before").height())+"px",marginLeft:"-"+Math.round(e*cutImg.coordXY.x)+"px",marginTop:"-"+Math.round(t*cutImg.coordXY.y)+"px"}),cutImg.nowJcrop.destroy()}},init=function(){$("#submit-button").bind("click",handle.submitClickHandle.bind(handle)),$("#file").bind("change",handle.fileChangeHandle.bind(handle)),$("#cutOK").bind("click",handle.cutOKclickHandle)};window.onload=function(){init()};